<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
		<meta name="description" content="">
		<meta name="author" content="">
		<!-- favicon all compatible links -->
		<link rel="icon" href="favicon.ico">
		<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
		<link rel="manifest" href="/site.webmanifest">
		<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
		<meta name="msapplication-TileColor" content="#da532c">
		<meta name="theme-color" content="#ffffff">
		<!-- favicon all compatible links end -->
		<title>Michiko (SQL)</title>
		<!-- Bootstrap core CSS -->
		<link href="css/bootstrap.min.css" rel="stylesheet">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
		<!-- Custom styles for this template -->
		<link href="css/jquery.bxslider.css" rel="stylesheet">
		<link href="css/style.css" rel="stylesheet">
	</head>
	<body>
		<!-- Navigation -->
		<nav class="navbar navbar-inverse navbar-fixed-top">
			<div class="container">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					</button>
				</div>
				<div id="navbar" class="collapse navbar-collapse">
					<ul class="nav navbar-nav">
						<li class="active"><a href="index.html">&#8629;</a></li>
						<li><a href="sql.html" style="text-decoration: underline;">SQL</a></li>
						<li><a href="uiux.html">UI/UX</a></li>
					</ul>

					<ul class="nav navbar-nav navbar-right">
					</ul>

				</div>
				<!--/.nav-collapse -->
			</div>
		</nav>

		<div class="container">
		<header>
		</header>
		<section>
			<div class="row">
				<div class="col-md-12">
					<p>**Data extractions and manippulations can be challenging. This is my study notes. My goal is to gain knowledge of SQL to write complex, highly-optimized queries across large volumes of data.</p>
					<article class="blog-post">
						<div class="blog-post-body">
							<h3>When creating/organizing tables, keep in mind...</h3>
							<div class="blog-post-text">

								<p>Normalization is the process of restructuring a relational database to reduce data redundancy and improve data integrity. Basically in my words, it’s optimizing and organizing database to manage effectively.</p>

								<h4>What are “normalized tables”?</h4>

								<ul class ="explanations">
									<li>Every row has the same number of columns.</li>
									<li>There is a unique key and everything in a row says something about the key. </li>
									<li>Facts that don't relate to the key belong in different tables.</li>
									<li>Tables shouldn't imply relationships that don't exist.</li>
								</ul>	

								<h3>Counting a zero value in rows</h3>
								<p>The count aggregation function is to count rows in a table. For example, below query will return the number of products.</p>
								
								<ul class ="query">
									<li>SELECT count(*)</li>
									<li>FROM products;</li>
								</ul>

								<img src = images/subqueries_table_1.png alt="subqueries_table_1"> 
								<img src = images/subqueries_table_2.png alt="subqueries_table_2">

								<p>What if we want to count a zero value while joining 2 tables? <br>Let's try this query.</p>

								<ul class ="query">
									<li>SELECT products.name, products.sku, count(*) as num</li>
									<li>FROM products join</li>
									<li>GROUP BY products.sku;</li>
								</ul>	

								<p>It returns only non-zero values. Why? Because, it’s inner join and only rows that are overwrapped between the tables will return. It doesn't show non-sales rows. Here is the solution.</p>

								<ul class ="query">
									<li>SELECT products.name, products.sku, COUNT(sales.sku) as num</li>
									<li>FROM products left join</li>
								    <li>ON products.sku = sales.sku</li>
							        <li>GROUP BY products.sku;</li>
							    </ul>
							        	
								<p>Notice that the join type changes to “left join” and count(*) changes to "count(sales.sku)." With left join the query returns all products(left side of table) including non-sales products. And by specifying the count column to be “sales.sku” the rows of "sales.sku" are counted instead of all the columns.</p>

								<h3>Subqueries 1</h3>
								<p>How to get the second highest value in the table with subquery.</p>						
								<ul class ="query">
									<li>SELECT name</li>
									<li>FROM products</li>
									<li>WHERE sku IN (SELECT sku FROM products</li>
									<ul class ="query">
									<li>WHERE price = (SELECT MAX(price) FROM products</li>
										<ul class ="query">
										<li>WHERE price < (SELECT MAX(price) FROM products)));</li>
									    </ul>
									</ul>
									
								</ul>

								<p>1. Get the highest price with query below.</p>

								<ul class ="query">
								<li>SELECT MAX(price)</li>
							    <li>FROM products</li>
							    </ul>

								<p>2. Create 2 layers of query from step 1 and connect with comparison operator "<" in the WHERE condition as an outer query.<br>3. Since sku is a primary key and it can bridge product name and the second highest price as an inner and an outer queries. Notice "IN" is being used to connect the inner query and the outer query to get multiple results in case it returns more than one row.</p>

								<h3>Subqueries 2</h3>							
								<P>Find the name of the sales_rep in each region with the largest amount of total_amt_usd sales.</P>
								<img src = images/subqueries_table_3.png alt="subqueries_table_3" style="padding-bottom: 20px">
								<p>1. Identify which tables are going to be used and the relationship between them. It’s asking “the name of the sales_rep in each region” so we are going to join sales_reps, region, accounts, and orders tables with FK and PK in order to extract the required information.</p>

								<ul class ="query">
									<li>FROM region r </li>
									<li>JOIN sales_reps sr</li>
									<li>ON r.id = s.region_id</li>
									<li>JOIN accounts a</li>
									<li>ON sr.id = a.sales_rep_id</li>
									<li>JOIN orders o</li>
									<li>ON a.id = o.account_id</li>
								</ul>
								<p>2. Next is to fill in the “SELECT” section to extract columns data. We want sales rep name, region name, and  total_amt_usd of each sales rep so we use SUM aggregation.  We apply group and order functions to organize the result.</p>	

								<ul class="query">
									<li>SELECT sr.name, r.name, SUM(total_amt_usd)</li>
									<li>FROM region r </li>
									<li>JOIN sales_reps sr</li>
									<li>ON r.id = s.region_id</li>
									<li>JOIN accounts a</li>
									<li>ON sr.id = a.sales_rep_id</li>
									<li>JOIN orders o</li>
									<li>ON a.id = o.account_id</li>
									<li>GROUP BY 1,2</li>
									<li>ORDER BY 3 DESC</li>
								</ul>	

								<p>3. The same region with different rep name and total number are returned as a result. We want the highest total amount with region name and sales rep name. We need to find out MAX of total_amt for each region so we pull MAX aggregation and region name and grouped by region name. The alias name "T1" is given.</p>

								<ul class="query">
								<li>SELECT region_name, MAX(total_amt) total_amt</li>
								<li>FROM(SELECT s.name rep_name, r.name region_name, SUM(o.total_amt_usd) total_amt</li>
						     		<ul class="query">
						             <li>FROM sales_reps s</li>
						             <li>JOIN accounts a</li>
						             <li>ON a.sales_rep_id = s.id</li>
						             <li>JOIN orders o</li>
						             <li>ON o.account_id = a.id</li>
						             <li>JOIN region r</li>
						             <li>ON r.id = s.region_id</li>
						             <li>GROUP BY 1, 2) t1</li>
						            </ul>	
								<li>GROUP BY 1;</li>
								</ul>	
								<p>4. Finally, we need to combine the 2 queries based on region name and total_amt.</p>
								<ul class="query">
									<li>SELECT t3.rep_name, t3.region_name, t3.total_amt</li>
									<li>FROM(SELECT region_name, MAX(total_amt) total_amt</li>
									<ul class ='query'>
										<li>FROM(SELECT s.name rep_name, r.name region_name, SUM(o.total_amt_usd) total_amt</li>							
										<ul class="query">
											<li>FROM sales_reps s</li>
									         <li>JOIN accounts a</li>
									         <li>ON a.sales_rep_id = s.id</li>
									         <li>JOIN orders o</li>
									         <li>ON o.account_id = a.id</li>
									         <li>JOIN region r</li>
									         <li>ON r.id = s.region_id</li>
									         <li>GROUP BY 1, 2) t1</li>
									     </ul>
									    <li>GROUP BY 1) t2 </li>   		
									</ul> 
									<li>JOIN (SELECT s.name rep_name, r.name region_name, SUM(o.total_amt_usd) total_amt</li>
										<ul class="query">
											<li>FROM sales_reps s</li>
									        <li>JOIN accounts a</li>
									        <li>ON a.sales_rep_id = s.id</li>
									        <li>JOIN orders o</li>
									        <li>ON o.account_id = a.id</li>
									        <li>JOIN region r</li>
									        <li>ON r.id = s.region_id</li>
									        <li>GROUP BY 1, 2</li>
									        <li>ORDER BY 3 DESC) t3</li>
									    </ul>	
									<li>ON t3.region_name = t2.region_name AND t3.total_amt = t2.total_amt;</li>    	
						        </ul>

						        <h3>Sorting data with Excel Pivot table</h3>

						        <p>Let’s say we want to understand how sales reps are doing and their managers as well. This time we use Oracle Live SQL. We create a view called “SR_VREP_VI” and it returns information whose job id is sales reps from employees table. We add a new column called full_name. The column is concat of employees first and last name in case if the same names exist and for clarity. Then, we call the view.</p>

						        <ul class="query">
						        	<li>CREATE VIEW SR_REP_VI AS (SELECT HR.EMPLOYEES.*, CONCAT(CONCAT(FIRST_NAME,' '), LAST_NAME) full_name</li>
						        	<li>FROM HR.EMPLOYEES</li>
						        	<li>WHERE JOB_ID = 'SA_REP');</li>
						        </ul>

						        <ul class="query">
						        	<li>SELECT *</li>
						        	<li>FROM SR_REP_VI;</li>
						        </ul>

						        <p>Now we extracted the data. We moved to Excel and use pivot table to sort out the data. Here are some of them. Bear in mind that MAC excel 2011 is depreciating and some of the key features like slice is missing so screen grabs are the best option to showcase the process. </p>	

						        <img src = images/data.png alt="data" style="padding-bottom: 20px">

						        <img src = images/agn_name_by_mng_ID-hired_yr.png alt="agn_name_by mng_ID-hired_yr" style="padding-bottom: 20px">

						        <p>The above table shows salary of Each agent grouped by manager they belong to. Additionally, hire date is sorted by year and we can see sales agents salary by seniority.</p>

						        <img src = images/agent_count_by_mng_ID-hired_yr.png alt="agent_count_by_mng_ID-hired_yr" style="padding-bottom: 20px">

						        <p>The above table shows the number agent in which year they were hired and grouped by manager they belong to. </p>

						        <img src = images/agent_count_by_salary.png alt="agent_count_by_salary" style="padding-bottom: 20px">

						        <p>The salary range is grouped by 1000. It shows how many sales agents earn in each range. Also, filter by hire date in year is avialbale.</p>

						        <p>With this micro data sorting practice we can learn how to sort and present data in charts or graphs to show comprehensive data analysis. Hooray!</>

						        

						       

							</div>
						</div>
					</article>
				</div>
			</div>
		</section>
		</div><!-- /.container -->

		<footer class="footer">
			<div class="footer-bottom">
				<p>This is my SQL study notes and some are taken from free/paid online courses I have taken. I'm happy to share my learning process and feel free to use however.</p>
			</div>
		</footer>

		<!-- Bootstrap core JavaScript
			================================================== -->
		<!-- Placed at the end of the document so the pages load faster -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<script src="js/jquery.bxslider.js"></script>
		<script src="js/mooz.scripts.min.js"></script>
	</body>
</html>